"""
Moment Card Generator - Moment Card ç”Ÿæˆå™¨
è´Ÿè´£ç”Ÿæˆç¬¬ä¸€äººç§°å™äº‹æ€»ç»“ã€æƒ…ç»ªæ ‡ç­¾ã€æ ‡é¢˜
"""

import os
from typing import Dict, Optional
from dataclasses import dataclass
from datetime import datetime
from dotenv import load_dotenv
from openai import OpenAI

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()
QWEN_API_KEY = os.getenv("ALIYUN_QWEN_KEY")

# åˆå§‹åŒ–é€šä¹‰åƒé—®å®¢æˆ·ç«¯
client = OpenAI(
    api_key=QWEN_API_KEY,
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1"
)

# æƒ…ç»ªé¢œè‰²æ˜ å°„
EMOTION_COLORS = {
    "joy": "#FFD700",           # é»„è‰²
    "sadness": "#9370DB",       # ç´«è‰²
    "anger": "#FF6347",         # çº¢è‰²
    "fear": "#4682B4",          # è“è‰²
    "love": "#FF69B4",          # ç²‰è‰²
    "surprise": "#FFA500",      # æ©™è‰²
    "neutral": "#D3D3D3",       # ç°è‰²
    "frustration": "#9E9E9E",   # æµ…ç°è‰²
    "embarrassment": "#CD5C5C", # æµ…çº¢è‰²ï¼ˆå°´å°¬ã€ç¤¾æ­»ï¼‰
    "shame": "#8B0000",         # æ·±çº¢è‰²ï¼ˆç¾è€»ã€ç¾æ„§ï¼‰
    "awkward": "#DDA0DD"        # æ·¡ç´«è‰²ï¼ˆä¸è‡ªåœ¨ã€åˆ«æ‰­ï¼‰
}


@dataclass
class MomentCard:
    """Moment Card æ•°æ®ç±»"""
    moment_id: str
    title: str
    summary: str
    emotion: str
    color: str
    timestamp: str
    message_count: int


def generate_moment_card(moment_data: Dict) -> MomentCard:
    """
    ç”Ÿæˆ Moment Card
    
    Args:
        moment_data: Moment æ•°æ®ï¼ˆåŒ…å« messagesï¼‰
    
    Returns:
        MomentCard: ç”Ÿæˆçš„å¡ç‰‡æ•°æ®
    """
    
    moment_id = moment_data['moment_id']
    messages = moment_data['messages']
    timestamp = moment_data['timestamp']
    
    # âš ï¸ é‡è¦ï¼šåªä½¿ç”¨ç”¨æˆ·æ¶ˆæ¯ç”Ÿæˆ Moment Cardï¼Œä¸åŒ…å« Agent å›å¤
    user_messages_only = [msg for msg in messages if msg['role'] == 'user']
    
    print(f"\nğŸ¨ æ­£åœ¨ç”Ÿæˆ Moment Card: {moment_id}")
    print(f"   æ€»æ¶ˆæ¯æ•°: {len(messages)}")
    print(f"   ç”¨æˆ·æ¶ˆæ¯æ•°: {len(user_messages_only)}")
    
    # Step 1: æå–ä¸»å¯¼æƒ…ç»ªï¼ˆåªåŸºäºç”¨æˆ·æ¶ˆæ¯ï¼‰
    emotion = _detect_dominant_emotion(user_messages_only)
    print(f"   æƒ…ç»ª: {emotion}")
    
    # Step 2: ç”Ÿæˆç¬¬ä¸€äººç§°å™äº‹æ€»ç»“ï¼ˆåªåŸºäºç”¨æˆ·æ¶ˆæ¯ï¼‰
    summary = _generate_narrative_summary(user_messages_only, emotion)
    print(f"   æ€»ç»“: {summary[:50]}...")
    
    # Step 3: ç”Ÿæˆæ ‡é¢˜
    title = _generate_title(summary, emotion)
    print(f"   æ ‡é¢˜: {title}")
    
    # Step 4: é€‰æ‹©é¢œè‰²
    color = EMOTION_COLORS.get(emotion.lower(), EMOTION_COLORS['neutral'])
    
    # åˆ›å»º Moment Card
    card = MomentCard(
        moment_id=moment_id,
        title=title,
        summary=summary,
        emotion=emotion,
        color=color,
        timestamp=timestamp,
        message_count=len(messages)
    )
    
    print(f"âœ… Moment Card ç”Ÿæˆå®Œæˆï¼\n")
    
    return card


def _detect_dominant_emotion(messages: list) -> str:
    """
    æ£€æµ‹å¯¹è¯ä¸­çš„ä¸»å¯¼æƒ…ç»ª
    
    Args:
        messages: æ¶ˆæ¯åˆ—è¡¨
    
    Returns:
        str: æƒ…ç»ªæ ‡ç­¾ï¼ˆjoy, sadness, anger, fear, love, surprise, neutral, frustrationï¼‰
    """
    
    # æå–æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯
    user_messages = [m['content'] for m in messages if m['role'] == 'user']
    conversation = "\n".join(user_messages)
    
    # ã€æ–°å¢ã€‘æ£€æµ‹"çº æ­£"è¡Œä¸º
    correction_keywords = ["çº æ­£", "ä¸æ˜¯", "æ˜¯", "å¾—è¯´ä¸€ä¸‹", "è®°é”™äº†", "å“ˆå“ˆ"]
    correction_count = sum(1 for msg in user_messages 
                          if any(kw in msg for kw in correction_keywords))
    
    # å¦‚æœå¤šæ¬¡çº æ­£ï¼Œå¾ˆå¯èƒ½æ˜¯FRUSTRATION
    if correction_count >= 2:
        # ä½†è¿˜æ˜¯è¦é€šè¿‡LLMç¡®è®¤ï¼Œé¿å…è¯¯åˆ¤
        pass
    
    prompt = f"""åˆ†æä»¥ä¸‹å¯¹è¯ï¼Œåˆ¤æ–­ç”¨æˆ·çš„ä¸»å¯¼æƒ…ç»ªã€‚

å¯¹è¯å†…å®¹ï¼š
{conversation}

è¯·ä»ä»¥ä¸‹æƒ…ç»ªä¸­é€‰æ‹©ä¸€ä¸ªæœ€ç¬¦åˆçš„ï¼š
- joyï¼ˆå¼€å¿ƒã€å–œæ‚¦ã€å…´å¥‹ï¼‰
- sadnessï¼ˆæ‚²ä¼¤ã€å¤±è½ã€éš¾è¿‡ï¼‰
- angerï¼ˆç”Ÿæ°”ã€æ„¤æ€’ã€æ¿€åŠ¨ï¼‰
- fearï¼ˆææƒ§ã€æ‹…å¿ƒã€ç„¦è™‘ï¼‰
- loveï¼ˆçˆ±ã€æ¸©æš–ã€æ„ŸåŠ¨ï¼‰
- surpriseï¼ˆæƒŠè®¶ã€æ„å¤–ï¼‰
- neutralï¼ˆä¸­æ€§ã€å¹³é™ã€æ­£å¸¸èŠå¤©ï¼‰
- frustrationï¼ˆè½»åº¦æ— å¥ˆã€æ— è¯­ã€è‡ªå˜²ï¼‰
- embarrassmentï¼ˆå°´å°¬ã€ç¤¾æ­»ã€ç¾è€»ï¼‰
- shameï¼ˆç¾è€»ã€ç¾æ„§ã€ä¸¢è„¸ï¼‰
- awkwardï¼ˆå°´å°¬ã€ä¸è‡ªåœ¨ã€åˆ«æ‰­ï¼‰

âš ï¸ **ç‰¹åˆ«æ³¨æ„**ï¼š
- å¦‚æœç”¨æˆ·åœ¨**çº æ­£Agent**ï¼ˆè¯´"æˆ‘å¾—çº æ­£ä½ "ã€"ä¸æ˜¯...æ˜¯..."ã€"è®°é”™äº†"ï¼‰ï¼Œæƒ…ç»ªæ˜¯**frustration**ï¼Œä¸æ˜¯loveæˆ–joy
- å¦‚æœç”¨æˆ·åªæ˜¯**ç¤¼è²Œæ€§å›åº”**ï¼ˆåœ¨çº æ­£ä¹‹åè¯´"å¿ƒé‡Œæš–æš–çš„"ï¼‰ï¼Œè¦ç†è§£è¯­å¢ƒï¼Œä¸è¦è¢«è¡¨é¢è¯æ±‡è¯¯å¯¼
- frustrationæ˜¯è½»åº¦æ— å¥ˆï¼Œå¸¦ç€"å“ˆå“ˆ"æˆ–"ğŸ˜‚"çš„åæ§½ï¼Œä¸æ˜¯çœŸçš„ç”Ÿæ°”
- **embarrassmentï¼ˆå°´å°¬ï¼‰**ï¼šç”¨æˆ·æåˆ°"ç¤¾æ­»"ã€"å½“åœºè£‚å¼€"ã€"å°´å°¬"ã€"æƒ³é’»åœ°ç¼"ç­‰ï¼Œæ˜¯å°´å°¬æƒ…ç»ªï¼Œä¸æ˜¯frustration
- **shameï¼ˆç¾è€»ï¼‰**ï¼šç”¨æˆ·æ„Ÿåˆ°ä¸¢è„¸ã€ç¾æ„§ï¼Œæ¯”embarrassmentæ›´ä¸¥é‡
- **awkwardï¼ˆä¸è‡ªåœ¨ï¼‰**ï¼šè½»å¾®çš„å°´å°¬ã€åˆ«æ‰­ï¼Œä¸å¦‚embarrassmentå¼ºçƒˆ
- è¦ç†è§£**æ•´ä½“å¯¹è¯æ°›å›´**ï¼Œä¸åªçœ‹å•ä¸ªå¥å­
- å¦‚æœå¯¹è¯ä¸­æåˆ°"ç¤¾æ­»"ã€"å°´å°¬"ã€"å½“åœºè£‚å¼€"ã€"æƒ³åŸåœ°æ¶ˆå¤±"ç­‰ï¼Œä¼˜å…ˆé€‰æ‹©**embarrassment**

åªè¿”å›æƒ…ç»ªæ ‡ç­¾ï¼Œä¸è¦è§£é‡Šã€‚ä¾‹å¦‚ï¼šjoy"""

    try:
        response = client.chat.completions.create(
            model="qwen-max",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3
        )
        
        emotion = response.choices[0].message.content.strip().lower()
        
        # éªŒè¯æ˜¯å¦æ˜¯æœ‰æ•ˆæƒ…ç»ªï¼ˆæ‰©å±•æƒ…ç»ªæ ‡ç­¾ï¼‰
        valid_emotions = ['joy', 'sadness', 'anger', 'fear', 'love', 'surprise', 'neutral', 'frustration', 
                         'embarrassment', 'shame', 'awkward']
        if emotion not in valid_emotions:
            print(f"   âš ï¸  æ— æ•ˆæƒ…ç»ªæ ‡ç­¾: {emotion}ï¼Œä½¿ç”¨ neutral")
            emotion = 'neutral'
        
        return emotion
        
    except Exception as e:
        print(f"   âš ï¸  æƒ…ç»ªæ£€æµ‹å¤±è´¥: {e}ï¼Œä½¿ç”¨ neutral")
        return 'neutral'


def _generate_narrative_summary(messages: list, emotion: str) -> str:
    """
    ç”Ÿæˆç¬¬ä¸€äººç§°å™äº‹æ€»ç»“
    
    Args:
        messages: æ¶ˆæ¯åˆ—è¡¨
        emotion: æƒ…ç»ªæ ‡ç­¾
    
    Returns:
        str: ç¬¬ä¸€äººç§°å™äº‹
    """
    
    # æ„å»ºå¯¹è¯å†å²
    conversation = ""
    for msg in messages:
        role_label = "æˆ‘" if msg['role'] == 'user' else "Ta"
        conversation += f"{role_label}: {msg['content']}\n"
    
    # ========================================
    # æ ¹æ®æ¶ˆæ¯æ•°é‡åŠ¨æ€è°ƒæ•´å­—æ•°è¦æ±‚
    # ========================================
    message_count = len(messages)
    
    if message_count <= 4:
        # çŸ­å¯¹è¯ï¼ˆ2è½®ä»¥å†…ï¼‰ï¼š40-60å­—
        word_limit = "40-60 å­—"
        detail_instruction = "ç®€çŸ­æ€»ç»“ä¸»è¦æ„Ÿå—ï¼Œ1-2 å¥è¯å³å¯"
    elif message_count <= 8:
        # ä¸­ç­‰å¯¹è¯ï¼ˆ4è½®ä»¥å†…ï¼‰ï¼š60-90å­—
        word_limit = "60-90 å­—"
        detail_instruction = "æç‚¼æ ¸å¿ƒè¯é¢˜å’Œä¸»è¦æ„Ÿå—ï¼Œ2-3 å¥è¯"
    elif message_count <= 16:
        # è¾ƒé•¿å¯¹è¯ï¼ˆ8è½®ä»¥å†…ï¼‰ï¼š80-120å­—
        word_limit = "80-120 å­—"
        detail_instruction = "æç‚¼æ ¸å¿ƒçŸ›ç›¾å’Œæƒ…ç»ªï¼Œæ¦‚æ‹¬è¦ç‚¹ï¼Œä¸è¦æµæ°´è´¦"
    else:
        # å¾ˆé•¿å¯¹è¯ï¼ˆ9è½®ä»¥ä¸Šï¼‰ï¼š90-130å­—
        word_limit = "90-130 å­—"
        detail_instruction = "æŠ“ä½æ ¸å¿ƒçŸ›ç›¾å’Œä¸»çº¿æƒ…ç»ªï¼Œé«˜åº¦æ¦‚æ‹¬ï¼Œé¿å…å¤è¯»æ‰€æœ‰ç»†èŠ‚"
    
    prompt = f"""åŸºäºä»¥ä¸‹å¯¹è¯ï¼Œç”¨ç¬¬ä¸€äººç§°è§†è§’å†™ä¸€æ®µå™äº‹ã€‚

å¯¹è¯å†…å®¹ï¼š
{conversation}

æƒ…ç»ªï¼š{emotion}
å¯¹è¯è½®æ•°ï¼š{message_count // 2} è½®
å­—æ•°è¦æ±‚ï¼š{word_limit}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ **æå…¶é‡è¦ï¼šè¿™æ˜¯"æç‚¼"ï¼Œä¸æ˜¯"å¤è¿°"ï¼**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**ä»€ä¹ˆæ˜¯å¤è¿°ï¼ˆä¸¥ç¦ï¼‰ï¼š**
æŠŠå¯¹è¯ä¸­æåˆ°çš„æ‰€æœ‰ç»†èŠ‚éƒ½å†™ä¸€éï¼ŒåƒæŠŠèŠå¤©è®°å½•æŠ„ä¸€éã€‚

**ä»€ä¹ˆæ˜¯æç‚¼ï¼ˆå¿…é¡»ï¼‰ï¼š**
åªå†™æ ¸å¿ƒçŸ›ç›¾å’Œä¸»çº¿æ„Ÿå—ï¼Œç»†èŠ‚åªä¿ç•™æœ€å…³é”®çš„ 2-3 ä¸ªã€‚

**ç¬¬ä¸€æ­¥ï¼šåˆ é™¤ 80% çš„ç»†èŠ‚**
- çœ‹å¯¹è¯ä¸­æåˆ°äº†å¤šå°‘ä¸ªç»†èŠ‚ï¼ˆäººã€åœ°ç‚¹ã€äº‹ä»¶ã€ç‰©å“ã€æ—¶é—´ï¼‰
- **åªä¿ç•™æœ€æ ¸å¿ƒçš„ 2-3 ä¸ª**ï¼Œå…¶ä»–å…¨éƒ¨åˆ æ‰
- ä¾‹å¦‚ï¼šå¯¹è¯æåˆ°äº† 10 ä¸ªç»†èŠ‚ï¼Œåªä¿ç•™ 2-3 ä¸ªæœ€é‡è¦çš„

**ç¬¬äºŒæ­¥ï¼šæ‰¾æ ¸å¿ƒçŸ›ç›¾ï¼ˆä¸€å¥è¯ï¼‰**
- è¿™æ¬¡å¯¹è¯çš„**æ ¸å¿ƒçŸ›ç›¾**æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆç”¨ä¸€å¥è¯æ¦‚æ‹¬ï¼‰
- ä¸æ˜¯åˆ—ä¸¾æ‰€æœ‰è¯é¢˜ï¼Œæ˜¯æ‰¾åˆ°è´¯ç©¿å§‹ç»ˆçš„é‚£ä¸ªä¸»çº¿

**ç¬¬ä¸‰æ­¥ï¼šç”¨æœ€å°‘çš„å­—è¡¨è¾¾**
- ç”¨æœ€ç®€ç»ƒçš„è¯è¯´æ¸…æ¥šæ ¸å¿ƒ
- èƒ½ç”¨ 5 ä¸ªå­—è¯´æ¸…æ¥šï¼Œå°±ä¸è¦ç”¨ 10 ä¸ªå­—
- èƒ½ç”¨ 1 å¥è¯ï¼Œå°±ä¸è¦ç”¨ 2 å¥è¯

**å…·ä½“è¦æ±‚ï¼š**
1. ç”¨ç¬¬ä¸€äººç§°ï¼ˆ"æˆ‘"ï¼‰
2. åƒå†™æ—¥è®°ï¼Œå£è¯­åŒ–ä½†ä¸ç”¨ç½‘ç»œçƒ‚æ¢—
3. {detail_instruction}
4. è‡ªç„¶ã€çœŸå®ï¼Œæœ‰è´¨æ„Ÿ
5. ä¸è¦ç”¨ä¹¦é¢è¯­ã€æˆè¯­ã€æ’æ¯”å¥
6. ä¸è¦ç”¨ç½‘ç»œæµè¡Œè¯­ã€çƒ‚æ¢—
7. **è¿™æ˜¯ä½ çš„å†…å¿ƒç‹¬ç™½ï¼Œä¸è¦æåˆ°"å¯¹æ–¹"ã€"æœ‹å‹"ã€"Ta"ã€"èŠå¤©"**
8. **ç›´æ¥å†™ä½ çš„æ„Ÿå—ã€æƒ³æ³•ã€ç»å†ï¼Œå°±åƒåœ¨è„‘æµ·ä¸­å›å¿†**
9. ä½“ç° {emotion} è¿™ç§æƒ…ç»ªï¼Œä½†åˆ«è¯´æ•™

âš ï¸ **ä¸¥ç¦ç¼–é€ ï¼**
- **åªèƒ½æ€»ç»“å¯¹è¯ä¸­æ˜ç¡®æåˆ°çš„å†…å®¹**
- **ä¸èƒ½æ·»åŠ å¯¹è¯ä¸­æ²¡æœ‰çš„ç»†èŠ‚ã€æ—¶é—´ã€åœ°ç‚¹ã€äººç‰©ã€äº‹ä»¶**
- **ä¸èƒ½æ·»åŠ "é˜³å…‰"ã€"å’–å•¡"ã€"å°ç‹—"ã€"éŸ³ä¹"ç­‰å¯¹è¯ä¸­æœªæåŠçš„å…ƒç´ **
- **âš ï¸ æå…¶é‡è¦ï¼šåŒºåˆ†"ç”¨æˆ·åœ¨é—®"å’Œ"ç”¨æˆ·åœ¨åš"**
  - å¦‚æœç”¨æˆ·åªæ˜¯åœ¨é—®é—®é¢˜ï¼ˆå¦‚"ä½ é€‰ä¸€ä¸ª"ã€"ä½ è§‰å¾—å‘¢"ï¼‰ï¼Œä¸è¦å†™æˆ"æˆ‘é€‰äº†"ã€"æˆ‘åšäº†"
  - å¦‚æœç”¨æˆ·åªæ˜¯åœ¨è¯¢é—®agentçš„æ„è§ï¼Œä¸è¦å†™æˆç”¨æˆ·è‡ªå·±çš„é€‰æ‹©æˆ–å†³å®š
  - ä¾‹å¦‚ï¼šç”¨æˆ·é—®"å´ç£Šè¿˜æ˜¯åˆ˜æ˜Šç„¶ï¼Œä½ é€‰ä¸€ä¸ª" â†’ è¿™æ˜¯é—®agentï¼Œä¸æ˜¯ç”¨æˆ·è‡ªå·±é€‰
  - æ­£ç¡®å†™æ³•ï¼š"é—®äº†agentæœ€å–œæ¬¢çš„ä¸­å›½ç”·æ¼”å‘˜ï¼Œæåˆ°äº†å´ç£Šå’Œåˆ˜æ˜Šç„¶"
  - é”™è¯¯å†™æ³•ï¼š"åœ¨å´ç£Šå’Œåˆ˜æ˜Šç„¶ä¹‹é—´é€‰æ‹©äº†åˆ˜æ˜Šç„¶"ï¼ˆè¿™æ˜¯è¯¯è§£ï¼Œç”¨æˆ·åªæ˜¯åœ¨é—®ï¼‰

âš ï¸ ç¦ç”¨è¯æ±‡ï¼š
ä¹¦é¢è¯­ï¼šå……æ»¡ã€é¼“èµ·å‹‡æ°”ã€ä¾æ—§ã€è™½ç„¶...ä½†æ˜¯ã€åªèƒ½ã€åŠªåŠ›ã€å°è¯•ã€å…‹æœ
ç½‘ç»œè¯­ï¼šå‹åŠ›å±±å¤§ã€å¿ƒæ€å´©äº†ã€emoã€ç ´é˜²ã€ç»ç»å­ã€YYDS
ç¦æ­¢æåŠï¼šå¯¹æ–¹ã€æœ‹å‹ã€Taã€èŠå¤©ã€äº¤æµ

ã€å¥½çš„ç¤ºä¾‹ - çŸ­å¯¹è¯ï¼ˆ2-3è½®ï¼‰ã€‘
å¯¹è¯ï¼š"ä»Šå¤©å¿ƒæƒ…å¥½äº†ï¼" "çœŸå¥½ï½"
âœ… å¥½çš„æ€»ç»“ï¼ˆ40å­—ï¼‰ï¼š"ä»Šå¤©å¿ƒæƒ…å¥½äº†å¾ˆå¤šï¼Œæ„Ÿè§‰æ•´ä¸ªäººéƒ½è½»æ¾äº†ã€‚"
âŒ åçš„æ€»ç»“ï¼ˆç¼–é€ ï¼‰ï¼š"ä»Šå¤©æ—©ä¸Šèµ·æ¥çœ‹åˆ°é˜³å…‰ï¼Œå¿ƒæƒ…å°±å¥½äº†ã€‚è·¯ä¸Šè¿˜ä¹°äº†æ¯å’–å•¡..."

ã€å¥½çš„ç¤ºä¾‹ - ä¸­ç­‰å¯¹è¯ï¼ˆ4-8è½®ï¼‰ã€‘
å¯¹è¯å†…å®¹ï¼šè®¨è®ºå·¥ä½œç¬¬ä¸‰å¹´ã€èŒä¸šè·¯å¾„ã€æŠ•å…¥äº§å‡ºæ¯”ã€å›¢é˜Ÿå®šä½ã€è¾¹é™…æå‡ã€æ¸…é†’ä½†ä¸è½»æ¾ã€è¡Œä¸šå˜åŒ–å‹åŠ›ã€å…è®¸æœªå®Œæˆåˆ¤æ–­
âœ… å¥½çš„æ€»ç»“ï¼ˆ80å­—ï¼Œæç‚¼æ ¸å¿ƒï¼‰ï¼š
"å·¥ä½œç¬¬ä¸‰å¹´ï¼Œå¼€å§‹ç®—èŒä¸šè·¯å¾„çš„æŠ•å…¥äº§å‡ºæ¯”ã€‚å›¢é˜ŸæŠŠåˆ†æå²—å®šä½æˆæ‰§è¡Œå±‚ï¼Œå‘ä¸Šç©ºé—´æœ‰é™ã€‚åœ¨æƒ³æ˜¯å¦è¦è·³å‡ºè¿™ä¸ªç»“æ„ï¼Œä½†æ¸…é†’å’Œè½»æ¾æ˜¯ä¸¤å›äº‹â€”â€”å…‰æ˜¯åšåˆ¤æ–­æœ¬èº«å°±å¾ˆè€—ã€‚ç°åœ¨å…ˆå…è®¸è‡ªå·±åœåœ¨æœªå®Œæˆåˆ¤æ–­çš„çŠ¶æ€ã€‚"

âŒ åçš„æ€»ç»“ï¼ˆå¤è¯»æœºï¼Œ120å­—ï¼‰ï¼š
"æœ€è¿‘åœ¨é‡æ–°è¯„ä¼°è‡ªå·±çš„èŒä¸šè·¯å¾„ã€‚å·¥ä½œç¬¬ä¸‰å¹´ï¼Œæ•°æ®åšå¾—ç†Ÿï¼Œä½†å‘ä¸Šç©ºé—´å’Œå®é™…å›æŠ¥ä¸å¤ªåŒ¹é…ã€‚å›¢é˜Ÿå¯¹åˆ†æå²—ä½çš„å®šä½åæ‰§è¡Œï¼Œå†³ç­–æƒå’Œèµ„æºé›†ä¸­åœ¨æ›´èµ„æ·±å±‚çº§ã€‚æˆ‘åœ¨è®¤çœŸç®—æŠ•å…¥äº§å‡ºæ¯”ï¼Œå¦‚æœç»§ç»­ç•™åœ¨è¿™é‡Œï¼Œä¸‰åˆ°äº”å¹´çš„è¾¹é™…æå‡å¯èƒ½æœ‰é™ã€‚æ¸…é†’å¹¶ä¸ç­‰äºè½»æ¾ï¼Œå¾ˆå¤šåˆ¤æ–­åšå‡ºæ¥ä¹‹å‰ï¼Œæœ¬èº«å°±å·²ç»æ¶ˆè€—ä¸å°‘ç²¾åŠ›..."

ã€å¥½çš„ç¤ºä¾‹ - é•¿å¯¹è¯ï¼ˆ9-16è½®ï¼‰ã€‘
å¯¹è¯å†…å®¹ï¼šå¾æ±‡ã€å‘¨æ¥ ã€åƒé¥­ã€è¿Ÿåˆ°20åˆ†é’Ÿã€å¤±æ€ã€è¢«å¿½è§†ã€è¯´è¯å†²ã€èººä¸‹ã€åœä¸ä¸‹æ¥ã€å…³ç³»å¤±è¡¡ã€ä¸€ç›´åœ¨ç­‰ã€é…åˆã€å‡è£…ä¸é‡è¦ã€11å·çº¿ã€å·®ç‚¹æ‰çœ¼æ³ªã€å¤±æ§

âœ… å¥½çš„æ€»ç»“ï¼ˆ100å­—ï¼ŒæŠ“ä½æ ¸å¿ƒï¼‰ï¼š
"æ˜¨å¤©åœ¨å¾æ±‡è·Ÿå‘¨æ¥ åƒé¥­ï¼Œå¥¹è¿Ÿåˆ° 20 åˆ†é’Ÿï¼Œæˆ‘çªç„¶å¤±æ§äº†â€”â€”å…¶å®ä¸æ˜¯å› ä¸ºè¿Ÿåˆ°ï¼Œæ˜¯é‚£ä¸€åˆ»æ„è¯†åˆ°å¾ˆå¤šå…³ç³»é‡Œè‡ªå·±ä¸€ç›´åœ¨ç­‰ã€åœ¨é…åˆï¼Œå´å‡è£…è¿™ä¸é‡è¦ã€‚å›å®¶åèººåœ¨åºŠä¸Šè„‘å­åœä¸ä¸‹æ¥ï¼Œåœ¨ 11 å·çº¿ä¸Šå·®ç‚¹æ‰çœ¼æ³ªã€‚å‘ç°è¿™ç§å¤±è¡¡è®©æˆ‘æœ‰ç‚¹æ…Œã€‚"

âŒ åçš„æ€»ç»“ï¼ˆå¤è¯»æœºï¼Œ150å­—ï¼‰ï¼š
"æ˜¨å¤©åœ¨å¾æ±‡è·Ÿå‘¨æ¥ åƒé¥­ï¼Œå¥¹è¿Ÿåˆ°äº†äºŒååˆ†é’Ÿï¼Œæˆ‘å´çªç„¶è§‰å¾—è‡ªå·±è¢«å¿½è§†äº†ï¼Œè¯´è¯å˜å¾—å¾ˆå†²ï¼Œè¿æˆ‘è‡ªå·±éƒ½æ„å¤–ã€‚å·²ç»å›åˆ°å®¶äº†ï¼Œä½†è„‘å­åœä¸ä¸‹æ¥ã€‚å…¶å®é—®é¢˜ä¸åœ¨è¿Ÿåˆ°ï¼Œæ˜¯æˆ‘çªç„¶æ„è¯†åˆ°ï¼Œå¾ˆå¤šå…³ç³»é‡Œæˆ‘ä¸€ç›´åœ¨ç­‰ã€åœ¨é…åˆï¼Œå´å‡è£…è¿™ä¸é‡è¦ã€‚èººä¸‹äº†ï¼Œä½†ä¸€å®‰é™ä¸‹æ¥å°±æ›´æ¸…æ¥šåœ°æ„Ÿè§‰åˆ°å¤±è¡¡ï¼Œè¿™ç§å‘ç°æœ¬èº«è®©æˆ‘æœ‰ç‚¹æ…Œã€‚æ˜¨æ™šåœ¨åœ°é“11å·çº¿ä¸Šå·®ç‚¹æ‰çœ¼æ³ªï¼Œé‚£ä¸€åˆ»çœŸçš„æœ‰ç‚¹å¤±æ§..."

ã€æ ¸å¿ƒå¯¹æ¯”ï¼šæç‚¼ vs å¤è¯»ã€‘
æç‚¼ç‰ˆç‰¹å¾ï¼š
- æ‰¾åˆ°æ ¸å¿ƒçŸ›ç›¾ï¼ˆ"ä¸æ˜¯è¿Ÿåˆ°ï¼Œæ˜¯ä¸€ç›´åœ¨ç­‰"ï¼‰
- ç®€ç»ƒè¡¨è¾¾ï¼ˆ"å¤±æ§"ä»£æ›¿"è¯´è¯å˜å¾—å¾ˆå†²è¿æˆ‘è‡ªå·±éƒ½æ„å¤–"ï¼‰
- ä¿ç•™å…³é”®ç»†èŠ‚ï¼ˆå‘¨æ¥ ã€å¾æ±‡ã€20åˆ†é’Ÿã€11å·çº¿ï¼‰
- åƒå›å¿†ï¼š"é‚£æ¬¡ä¸»è¦æ˜¯å‘ç°è‡ªå·±ä¸€ç›´åœ¨ç­‰"

å¤è¯»ç‰ˆç‰¹å¾ï¼š
- æŠŠå¯¹è¯çš„æ¯å¥è¯éƒ½å†™ä¸€é
- ç»†èŠ‚å †ç Œï¼ˆ"è¯´è¯å˜å¾—å¾ˆå†²ï¼Œè¿æˆ‘è‡ªå·±éƒ½æ„å¤–"ï¼‰
- æµæ°´è´¦å¼å™è¿°
- åƒèŠå¤©è®°å½•è½¬å½•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸ **çœŸå®é”™è¯¯æ¡ˆä¾‹è­¦ç¤ºï¼ˆå¿…çœ‹ï¼‰**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**æ¡ˆä¾‹ï¼šæœ›å¹³è¡—æ‰“ç«æœºäº‹ä»¶**
å¯¹è¯åŒ…å« 10+ ä¸ªç»†èŠ‚ï¼šæœ›å¹³è¡—ã€æ±Ÿè¾¹ã€æ –è¿ŸèŒ¶é¦†ã€é˜¿å“²ã€17åˆ†é’Ÿã€è–„è·ç»¿æ‰“ç«æœºã€æ€•å†·ã€æ‰‹æœº22:30å‹¿æ‰°ã€çª—è¾¹ã€å®³æ€•ã€ä¾¿åˆ©åº—ã€è€æ¿å¨˜ã€è¯æ¢…...

âŒ **å®é™…ç”Ÿæˆçš„é”™è¯¯ç‰ˆæœ¬ï¼ˆ120å­—ï¼‰ï¼š**
"ä»Šå¤©åœ¨æœ›å¹³è¡—æ±Ÿè¾¹ç­‰é˜¿å“²ï¼Œä»–è¿Ÿåˆ°äº†17åˆ†é’Ÿï¼Œè¿˜å¼„ä¸¢äº†ä»–é€æˆ‘çš„è–„è·ç»¿æ‰“ç«æœºã€‚é‚£ä¸€åˆ»å§”å±ˆçªç„¶æ¶Œä¸Šæ¥ï¼Œä¸æ˜¯å› ä¸ºæ‰“ç«æœºæœ¬èº«ï¼Œè€Œæ˜¯é‚£ä»½è¢«è®°å¾—çš„æ„Ÿè§‰å¥½åƒä¹Ÿè·Ÿç€ä¸¢äº†ã€‚å›å®¶åæˆ‘æŠŠæ‰‹æœºè®¾æˆå‹¿æ‰°æ¨¡å¼ï¼Œååœ¨çª—è¾¹æƒ³äº†å¾ˆä¹…ï¼Œå®³æ€•é‚£äº›è¢«è®°å¾—çš„å°äº‹æ…¢æ…¢æ¶ˆå¤±ã€‚åæ¥åœ¨å°åŒºé—¨å£ä¾¿åˆ©åº—ï¼Œè€æ¿å¨˜è®¤å‡ºæˆ‘ï¼Œå¤šé€äº†é¢—è¯æ¢…ï¼Œé‚£ä¸€ç¬é—´æˆ‘ç¬‘äº†ã€‚åŸæ¥è¢«è®°å¾—ä¹Ÿå¯ä»¥æ˜¯è¿™æ ·ç®€å•çš„ç”Ÿæ´»å°ç¬é—´ã€‚"

**é—®é¢˜ï¼šæŠŠæ‰€æœ‰ç»†èŠ‚éƒ½å†™äº†ï¼åƒå¤åˆ¶ç²˜è´´èŠå¤©è®°å½•ï¼**

âœ… **åº”è¯¥ç”Ÿæˆï¼ˆæç‚¼ç‰ˆï¼Œ60å­—ï¼‰ï¼š**
"å› ä¸ºé˜¿å“²è¿Ÿåˆ°å’Œæ‰“ç«æœºä¸¢äº†ï¼Œçªç„¶æ„è¯†åˆ°æ€•çš„ä¸æ˜¯ä¸œè¥¿ä¸¢ï¼Œæ˜¯é‚£ä»½è¢«è®°å¾—çš„æ„Ÿè§‰ä¹Ÿè·Ÿç€æ¶ˆå¤±ã€‚åæ¥ä¾¿åˆ©åº—è€æ¿å¨˜çš„å°ä¸¾åŠ¨æé†’æˆ‘ï¼Œè¢«è®°å¾—ä¹Ÿå¯ä»¥å¾ˆç®€å•ã€‚"

**æ”¹è¿›ï¼šåªä¿ç•™æ ¸å¿ƒï¼ˆè¢«è®°å¾—çš„æ„Ÿè§‰ï¼‰+ 2ä¸ªå…³é”®äººç‰©ï¼ˆé˜¿å“²ã€è€æ¿å¨˜ï¼‰ï¼Œåˆ æ‰äº† 80% çš„ç»†èŠ‚ï¼**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**è®°ä½ï¼šæç‚¼çš„æœ¬è´¨æ˜¯"åˆ é™¤ 80% çš„ç»†èŠ‚ï¼Œåªç•™æ ¸å¿ƒ"**
**ä¸æ˜¯"æŠŠæ‰€æœ‰è¯ç”¨è‡ªå·±çš„è¯è¯´ä¸€é"ï¼**

åªè¿”å›å™äº‹å†…å®¹ï¼Œä¸è¦å‰ç¼€æˆ–è§£é‡Šã€‚"""

    try:
        response = client.chat.completions.create(
            model="qwen-max",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.1  # æä½æ¸©åº¦ï¼Œä¸¥æ ¼éµå¾ª"æç‚¼ vs å¤è¿°"è§„åˆ™
        )
        
        summary = response.choices[0].message.content.strip()
        return summary
        
    except Exception as e:
        print(f"   âš ï¸  æ€»ç»“ç”Ÿæˆå¤±è´¥: {e}")
        return "ä»Šå¤©è®°å½•äº†ä¸€æ®µå¯¹è¯ï¼Œç•™ä¸‹äº†è¿™ä¸ªç¬é—´ã€‚"


def _generate_title(summary: str, emotion: str) -> str:
    """
    ç”Ÿæˆ Moment æ ‡é¢˜
    
    Args:
        summary: å™äº‹æ€»ç»“
        emotion: æƒ…ç»ªæ ‡ç­¾
    
    Returns:
        str: æ ‡é¢˜ï¼ˆä¸­æ–‡ï¼‰
    """
    
    prompt = f"""åŸºäºä»¥ä¸‹å™äº‹æ€»ç»“ï¼Œç”Ÿæˆä¸€ä¸ªç®€çŸ­çš„æ ‡é¢˜ã€‚

å™äº‹æ€»ç»“ï¼š
{summary}

æƒ…ç»ªï¼š{emotion}

è¦æ±‚ï¼š
1. 4-8 ä¸ªå­—
2. å£è¯­åŒ–ã€è‡ªç„¶ï¼Œä½†ä¸è¦ç”¨ç½‘ç»œçƒ‚æ¢—
3. æœ‰è´¨æ„Ÿï¼Œä¸ä¿—æ°”
4. ä¸è¦ç”¨å¼•å·ã€ä¹¦åå·
5. åƒåœ¨ç»™äº²å¯†æœ‹å‹å†™çŸ­ä¿¡

å¥½çš„ç¤ºä¾‹ï¼š
- "è¿™ä¸ªé¡¹ç›®æœ‰ç‚¹éš¾"
- "ä»Šæ™šç¡ä¸ç€"
- "ç»ˆäºåšå®Œäº†"
- "æƒ³å›å®¶äº†"
- "å¿ƒé‡Œæš–æš–çš„"
- "æœ‰ç‚¹æ…Œ"

åçš„ç¤ºä¾‹ï¼ˆä¸è¦æ¨¡ä»¿ï¼‰ï¼š
- "å‹åŠ›å±±å¤§" â† ç½‘ç»œçƒ‚æ¢—
- "å¿ƒæ€å´©äº†" â† å¤ªç½‘ç»œåŒ–
- "emo äº†" â† å¤ªæµè¡Œè¯­
- "ç ´é˜²äº†" â† å¤ªçƒ‚æ¢—
- "æœªçŸ¥æŒ‘æˆ˜å‰çš„å¿å¿‘" â† å¤ªä¹¦é¢
- "å‹‡æ°”ä¸åšæŒ" â† å¤ªå‡

åªè¿”å›æ ‡é¢˜ï¼Œä¸è¦è§£é‡Šã€‚"""

    try:
        response = client.chat.completions.create(
            model="qwen-max",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.8  # é€‚ä¸­æ¸©åº¦ï¼Œä¿æŒä¸€å®šåˆ›é€ æ€§
        )
        
        title = response.choices[0].message.content.strip()
        # ç§»é™¤å¯èƒ½çš„å¼•å·å’Œä¹¦åå·
        title = title.replace('"', '').replace("'", '').replace('ã€Š', '').replace('ã€‹', '')
        return title
        
    except Exception as e:
        print(f"   âš ï¸  æ ‡é¢˜ç”Ÿæˆå¤±è´¥: {e}")
        return f"ä»Šå¤©æœ‰ç‚¹{emotion}"


# ============================================================
# æµ‹è¯•ä»£ç 
# ============================================================

def test_moment_card():
    """æµ‹è¯• Moment Card ç”Ÿæˆ"""
    
    print("\n" + "="*60)
    print("ğŸ§ª æµ‹è¯• Moment Card ç”Ÿæˆ")
    print("="*60 + "\n")
    
    # æ¨¡æ‹Ÿ Moment æ•°æ®
    test_moment = {
        "moment_id": "moment_test",
        "timestamp": datetime.now().isoformat(),
        "messages": [
            {"role": "user", "content": "æˆ‘æœ‰ä¸ªå¾ˆéš¾çš„ projectï¼Œä¸çŸ¥é“èƒ½ä¸èƒ½åšæˆ", "emotion": "worry"},
            {"role": "assistant", "content": "å¬èµ·æ¥æ˜¯ä¸ªå¾ˆæœ‰æŒ‘æˆ˜çš„é¡¹ç›®ã€‚èƒ½è·Ÿæˆ‘è¯´è¯´å…·ä½“æ˜¯ä»€ä¹ˆæ ·çš„ project å—ï¼Ÿ", "emotion": "neutral"},
            {"role": "user", "content": "æ˜¯ä¸€ä¸ª AI Agent é¡¹ç›®ï¼ŒæŠ€æœ¯æ ˆå¾ˆå¤æ‚ï¼Œæˆ‘æ‹…å¿ƒæä¸å®š", "emotion": "fear"},
            {"role": "assistant", "content": "å—¯ï¼ŒAI Agent ç¡®å®æŒºå¤æ‚çš„ã€‚ä¸è¿‡æˆ‘çœ‹å¾—å‡ºæ¥ä½ æ˜¯è®¤çœŸåœ¨æ€è€ƒè¿™ä¸ªé¡¹ç›®çš„ï¼Œè¿™æœ¬èº«å°±å¾ˆå‰å®³äº†ã€‚", "emotion": "supportive"},
            {"role": "user", "content": "è°¢è°¢ï¼Œæˆ‘ä¼šåŠªåŠ›è¯•è¯•çš„", "emotion": "hopeful"}
        ]
    }
    
    # ç”Ÿæˆ Moment Card
    card = generate_moment_card(test_moment)
    
    # æ˜¾ç¤ºç»“æœ
    print("\n" + "="*60)
    print("ğŸ“‡ ç”Ÿæˆçš„ Moment Card")
    print("="*60)
    print(f"Moment ID: {card.moment_id}")
    print(f"æ ‡é¢˜: {card.title}")
    print(f"æƒ…ç»ª: {card.emotion}")
    print(f"é¢œè‰²: {card.color}")
    print(f"æ€»ç»“:")
    print(f"{card.summary}")
    print(f"\næ—¶é—´: {card.timestamp}")
    print(f"æ¶ˆæ¯æ•°: {card.message_count}")
    print("="*60 + "\n")


if __name__ == "__main__":
    test_moment_card()
